___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "PiwikPro",
  "brand": {
    "id": "brand_dummy",
    "displayName": "stape.io",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Tag that sends the event data from the GA4/Data/PiwikPro client to PiwikPro.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "configGroup",
    "displayName": "",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "RADIO",
        "name": "eventType",
        "displayName": "Event Name Setup Method",
        "radioItems": [
          {
            "value": "inherit",
            "displayValue": "Inherit from client"
          },
          {
            "value": "custom",
            "displayValue": "Custom",
            "subParams": [
              {
                "type": "RADIO",
                "name": "eventTypeCustom",
                "radioItems": [
                  {
                    "value": "pageView",
                    "displayValue": "Page View"
                  },
                  {
                    "value": "event",
                    "displayValue": "Event",
                    "subParams": [
                      {
                        "type": "TEXT",
                        "name": "eventCategory",
                        "displayName": "Event Category",
                        "simpleValueType": true,
                        "valueValidators": [
                          {
                            "type": "NON_EMPTY"
                          }
                        ]
                      },
                      {
                        "type": "TEXT",
                        "name": "eventAction",
                        "displayName": "Event Action",
                        "simpleValueType": true,
                        "valueValidators": [
                          {
                            "type": "NON_EMPTY"
                          }
                        ]
                      },
                      {
                        "type": "TEXT",
                        "name": "eventName",
                        "displayName": "Event Name",
                        "simpleValueType": true,
                        "valueValidators": [
                          {
                            "type": "NON_EMPTY"
                          }
                        ]
                      }
                    ]
                  }
                ],
                "simpleValueType": true
              }
            ]
          }
        ],
        "simpleValueType": true,
        "defaultValue": "inherit"
      },
      {
        "type": "TEXT",
        "name": "trackingUrl",
        "displayName": "Tracking URL",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "REGEX",
            "args": [
              "^https://.*"
            ]
          },
          {
            "type": "REGEX",
            "args": [
              ".*\\/$"
            ]
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "siteId",
        "displayName": "Site ID",
        "simpleValueType": true,
        "help": "The ID of the website we\u0027re tracking a visit/action for."
      },
      {
        "type": "TEXT",
        "name": "tokenAuth",
        "displayName": "Auth Token",
        "simpleValueType": true,
        "help": "You can get the auth key in your profile settings"
      },
      {
        "type": "CHECKBOX",
        "name": "enableEcommerceTracking",
        "checkboxText": "Enable Ecommerce Tracking",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "useOptimisticScenario",
        "checkboxText": "Use Optimistic Scenario",
        "simpleValueType": true,
        "help": "The tag will call gtmOnSuccess() without waiting for a response from the API"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "eventParametersGroup",
    "displayName": "Event Parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "parametersToOverride",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "requestHeadersGroup",
    "displayName": "Request Headers",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "requestHeaders",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "tagExecutionConsentSettingsGroup",
    "displayName": "Tag Execution Consent Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "adStorageConsent",
        "displayName": "",
        "radioItems": [
          {
            "value": "optional",
            "displayValue": "Send data always"
          },
          {
            "value": "required",
            "displayValue": "Send data in case marketing consent given",
            "help": "Aborts the tag execution if marketing consent (\u003ci\u003ead_storage\u003c/i\u003e Google Consent Mode or Stape\u0027s Data Tag parameter) is not given."
          }
        ],
        "simpleValueType": true,
        "defaultValue": "optional"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "logSettingsGroup",
    "displayName": "Logs Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "displayName": "",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const encodeUriComponent = require('encodeUriComponent');
const generateRandom = require('generateRandom');
const getAllEventData = require('getAllEventData');
const getContainerVersion = require('getContainerVersion');
const getCookieValues = require('getCookieValues');
const getRequestHeader = require('getRequestHeader');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const makeString = require('makeString');
const Object = require('Object');
const sendHttpRequest = require('sendHttpRequest');
const setCookie = require('setCookie');

/*==============================================================================
==============================================================================*/

const isLoggingEnabled = determinateIsLoggingEnabled();
const traceId = isLoggingEnabled ? getRequestHeader('trace-id') : undefined;
const eventData = getAllEventData();
const eventNameData = getEventNameData();
const eventName = eventNameData.e_n;
let postUrl = data.trackingUrl;

if (!isConsentGivenOrNotRequired(data, eventData)) {
  return data.gtmOnSuccess();
}

if (postUrl.indexOf('ppms.php', postUrl.length - 10) === -1) {
  postUrl = postUrl + 'ppms.php';
}

const params = getPiwikParams(eventNameData);

if (data.parametersToOverride && data.parametersToOverride.length) {
  data.parametersToOverride.forEach((param) => {
    if (isValidParam(param.value)) {
      params[param.name] = param.value;
    }
  });
}

const queryParamsString = objectToQueryString(params);
if (queryParamsString) {
  postUrl = postUrl + '?' + queryParamsString;
}

const headers = {
  'Content-Type': 'text/plain;charset=UTF-8'
};

if (data.requestHeaders && data.requestHeaders.length) {
  data.requestHeaders.forEach((header) => {
    headers[header.name] = header.value;
  });
}

if (isLoggingEnabled) {
  logToConsole(
    JSON.stringify({
      Name: 'PiwikProTag',
      Type: 'Request',
      TraceId: traceId,
      EventName: eventName,
      RequestMethod: 'GET',
      RequestUrl: postUrl,
      RequestHeaders: headers
    })
  );
}

sendHttpRequest(postUrl, {
  headers: headers,
  method: 'GET'
})
  .then((response) => {
    if (isLoggingEnabled) {
      logToConsole(
        JSON.stringify({
          Name: 'PiwikProTag',
          Type: 'Response',
          TraceId: traceId,
          EventName: eventName,
          ResponseStatusCode: response.statusCode,
          ResponseHeaders: response.headers,
          ResponseBody: response.body
        })
      );
    }
    if (!data.useOptimisticScenario) {
      if (response.statusCode >= 200 && response.statusCode < 300) {
        data.gtmOnSuccess();
      } else {
        data.gtmOnFailure();
      }
    }
  })
  .catch(() => {
    if (!data.useOptimisticScenario) {
      data.gtmOnFailure();
    }
  });

if (data.useOptimisticScenario) {
  data.gtmOnSuccess();
}

/*==============================================================================
Vendor related functions
==============================================================================*/

function getEventNameData() {
  if (data.eventType === 'inherit') {
    if (
      eventData.event_name === 'page_view' ||
      eventData.event_name === 'Data' ||
      !eventData.event_name
    ) {
      return {
        e_c: '',
        e_a: '',
        e_n: 'page_view'
      };
    }

    return {
      e_c: eventData.event_category,
      e_a: eventData.event_action,
      e_n: eventData.event_name
    };
  } else {
    return {
      e_c: data.eventCategory,
      e_a: data.eventAction,
      e_n: data.eventName
    };
  }
}

function getECItems() {
  if (eventData.ec_items) {
    return eventData.ec_items;
  }

  return eventData.items
    ? JSON.stringify(
        eventData.items.map((item) => [
          item.item_id,
          item.item_name,
          item.item_category,
          item.price,
          item.quantity
        ])
      )
    : '';
}

function getVisitorId() {
  let piwikClientIdName = '_pk_.' + data.siteId;
  let piwikClientId = getCookieValues(piwikClientIdName)[0];
  if (!piwikClientId) piwikClientId = eventData._id;

  if (!piwikClientId) {
    piwikClientId = getTimestampMillis() + '' + generateRandom(1000000000, 2147483647);
  }

  piwikClientId = piwikClientId ? makeString(piwikClientId).slice(0, 16) : '';

  if (piwikClientId) {
    const cookieOptions = {
      domain: 'auto',
      path: '/',
      samesite: 'Lax',
      secure: true,
      'max-age': 34560000, // 400 days
      HttpOnly: !!data.useHttpOnlyCookie
    };

    if (piwikClientId) {
      setCookie(piwikClientIdName, piwikClientId, cookieOptions);
    }
  }

  return piwikClientId;
}

function getPiwikParams(eventNameData) {
  const visitorId = getVisitorId();

  const piwikParams = {
    // Required parameters
    idsite: data.siteId,
    rec: eventData.rec || 1,
    ts_n: 'sgtm_stape',
    ts_v: '1.0.1',

    // Recommended parameters
    action_name:
      eventNameData.e_n === 'page_view'
        ? eventData.page_title || eventData.action_name
        : eventNameData.e_a,
    url: eventData.page_location || eventData.url,
    _id: visitorId,
    rand: eventData['x-ga-page_id'],
    apiv: eventData.apiv || 1,

    // Optional User info
    urlref: eventData.page_referrer || eventData.urlref || eventData.referrer,
    res: eventData.screen_resolution || eventData.res,
    h: eventData.h,
    m: eventData.m,
    s: eventData.s,
    cookie: eventData.cookie,
    ua: eventData.user_agent,
    uadata: eventData.uadata,
    lang: eventData.lang || eventData.language,
    uid: eventData.uid || eventData.user_id,
    cid: visitorId,
    new_visit: eventData.new_visit,

    // Acquisition Channel Attribution
    _rcn: eventData.affiliation || eventData['_rcn'],
    _rck: eventData['_rck'],

    // Optional Action info
    cvar: eventData.cvar,
    link: eventData.link,
    download: eventData.download,
    search: eventData.search || eventData.search_term,
    search_cat: eventData.search_cat,
    search_count: eventData.search_count,
    pv_id: eventData['x-ga-page_id'],
    idgoal: data.enableEcommerceTracking ? 0 : '',
    revenue: eventData.revenue || eventData.value,
    gt_ms: eventData.gt_ms,
    cs: eventData.cs,
    // ca: eventData.ca, // Not supported

    // Page Performance Info
    pf_net: eventData.pf_net,
    pf_srv: eventData.pf_srv,
    pf_tfr: eventData.pf_tfr,
    pf_dm1: eventData.pf_dm1,
    pf_dm2: eventData.pf_dm2,
    pf_onl: eventData.pf_onl,

    // Event Tracking info
    e_c: eventNameData.e_c,
    e_a: eventNameData.e_a,
    e_n: eventNameData.e_n,
    e_v: eventNameData.e_n === 'page_view' ? '' : eventData.value,

    // Optional Content Tracking info
    c_n: eventData.c_n,
    c_p: eventData.c_p,
    c_t: eventData.c_t,
    c_i: eventData.c_i,

    // Optional Ecommerce info
    ec_id: eventData.ec_id || eventData.transaction_id,
    ec_items: getECItems(),
    ec_st: eventData.value || eventData.ec_st,
    ec_tx: eventData.ec_tx || eventData.tax,
    ec_sh: eventData.ec_sh || eventData.shipping,
    ec_dt: eventData.ec_dt || eventData.discount_amount,

    // Other parameters
    token_auth: data.tokenAuth,
    cip: data.tokenAuth ? eventData.cip || eventData.ip_override : '',
    cdt: eventData.cdt,
    country: eventData.country,
    region: eventData.region,
    city: eventData.city,
    lat: eventData.lat,
    long: eventData.long,

    // Media Analytics
    ma_id: eventData.ma_id,
    ma_ti: eventData.ma_ti,
    ma_re: eventData.ma_re,
    ma_mt: eventData.ma_mt,
    ma_pn: eventData.ma_pn,
    ma_st: eventData.ma_st,
    ma_le: eventData.ma_le,
    ma_ps: eventData.ma_ps,
    ma_ttp: eventData.ma_ttp,
    ma_w: eventData.ma_w,
    ma_h: eventData.ma_h,
    ma_fs: eventData.ma_fs,
    ma_se: eventData.ma_se
  };

  return Object.keys(piwikParams).reduce((acc, key) => {
    if (isValidParam(piwikParams[key])) {
      acc[key] = piwikParams[key];
    }
    return acc;
  }, {});
}

/*==============================================================================
Helpers
==============================================================================*/

function isConsentGivenOrNotRequired(data, eventData) {
  if (data.adStorageConsent !== 'required') return true;
  if (eventData.consent_state) return !!eventData.consent_state.analytics_storage;
  const xGaGcs = eventData['x-ga-gcs'] || ''; // x-ga-gcs is a string like "G110"
  return xGaGcs[3] === '1'; // The fourth character indicates analytics_storage consent
}

function isValidParam(value) {
  const valueType = getType(value);
  return valueType !== 'undefined' && valueType !== 'null' && value !== '';
}

function objectToQueryString(obj) {
  return Object.keys(obj)
    .map((key) => (isValidParam(obj[key]) ? key + '=' + encodeUriComponent(obj[key]) : key))
    .join('&');
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "remoteAddressAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []
setup: |-
  const mockData = {
    client_id: 'cbgvsuyicjkbhsdgvcgyuhkds'
  };

  // Call runCode to run the template's code.
  runCode(mockData);


___NOTES___

Created on 07/03/2024, 11:09:00


